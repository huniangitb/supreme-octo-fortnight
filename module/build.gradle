// build.gradle

import org.apache.tools.ant.filters.FixCrLfFilter
import java.nio.file.Paths
import java.nio.file.Files

apply plugin: 'com.android.library'
apply from: file(rootProject.file('module.gradle'))

// ... [android, repositories 等配置保持不变] ...
android {
    // ...
    namespace 'aknoryx.zygisktz'
}

repositories {
    mavenLocal()
}

androidComponents {
    onVariants(selector().withBuildType("release")) { variant ->
        def variantCapped = variant.name.capitalize()
        def variantLowered = variant.name.toLowerCase()

        def zipName = "${magiskModuleId.replace('_', '-')}-${moduleVersion}-${variantLowered}.zip"
        def magiskDir = file("$outDir/magisk_module_$variantLowered")

        def prepareTask = tasks.register("prepareMagiskFiles${variantCapped}", Sync) {
            // 这个任务现在只负责复制模板文件
            def templatePath = "$rootDir/template/magisk_module"
            into magiskDir
            from(templatePath) {
                exclude 'module.prop'
            }
            from(templatePath) {
                include 'module.prop'
                expand([
                        id         : magiskModuleId,
                        name       : moduleName,
                        version    : moduleVersion,
                        versionCode: moduleVersionCode.toString(),
                        author     : moduleAuthor,
                        description: moduleDescription,
                ])
                filter(FixCrLfFilter.class,
                        eol: FixCrLfFilter.CrLf.newInstance("lf"))
            }

            // 在任务执行的最后，调用 shell 脚本来处理 .so 文件
            doLast {
                exec {
                    workingDir project.projectDir // 在模块目录下执行
                    commandLine 'sh', './copy_native_libs.sh', buildDir, magiskDir, moduleLibraryName
                }
            }
        }

        // 确保原生代码编译在 prepareTask 之前完成
        prepareTask.configure {
            dependsOn "assemble${variantCapped}"
        }

        def zipTask = tasks.register("zip${variantCapped}", Zip) {
            dependsOn(prepareTask)
            from magiskDir
            archiveFileName.set(zipName)
            destinationDirectory.set(outDir)
        }

        // ... [push, flash 等任务保持不变] ...
    }
}